<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± b√°o (ML) - AIoT Weather</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="app-logo">
                <span class="logo-icon">üå§Ô∏è</span>
                <div>
                    <div class="app-title">AIoT Weather</div>
                    <div class="app-subtitle">AIoT-ML</div>
                </div>
            </div>
        </div>
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-icon">üè†</span>
                        <span>T·ªïng quan</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="charts.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        <span>Bi·ªÉu ƒë·ªì & Ph√¢n t√≠ch</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="forecast.html" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span>D·ª± b√°o (ML)</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="ml-training.html" class="nav-link">
                        <span class="nav-icon">üöÄ</span>
                        <span>Hu·∫•n luy·ªán ML</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="mysql.html" class="nav-link">
                        <span class="nav-icon">üíæ</span>
                        <span>Qu·∫£n l√Ω d·ªØ li·ªáu MySQL</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>C·∫•u h√¨nh h·ªá th·ªëng</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="hamburger-btn" id="hamburgerBtn">‚ò∞</button>
                <h1 class="page-title">D·ª± b√°o (ML)</h1>
            </div>
            <div class="topbar-right">
                <div class="clock-display">
                    <span class="clock-time" id="clockTime">00:00:00</span>
                    <span class="clock-label">GMT+7</span>
                </div>
                <div class="status-badge connected" id="mysqlStatus">
                    <span class="status-dot"></span> MySQL: Connected
                </div>
                <button class="theme-toggle" id="themeToggle">üåô</button>
            </div>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Forecast Summary -->
            <section class="section">
                <div class="card" style="text-align: center; padding: 30px;">
                    <div style="font-size: 64px; margin-bottom: 15px;" id="weatherIcon">üå§Ô∏è</div>
                    <h2 style="font-size: 24px; margin-bottom: 10px;" id="forecastSummary">ƒêang t·∫£i d·ª± b√°o...</h2>
                    <p style="font-size: 16px; color: var(--text-secondary);" id="forecastDetail">--</p>
                    <button class="btn btn-primary mt-20" onclick="loadForecastData()">
                        üîÑ L√†m m·ªõi d·ª± b√°o
                    </button>
                </div>
            </section>

            <!-- Forecast Table -->
            <section class="section">
                <h2 class="section-title">D·ª± b√°o chi ti·∫øt 12 gi·ªù t·ªõi</h2>
                <div class="table-container">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian</th>
                                    <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
                                    <th>ƒê·ªô ·∫©m (%)</th>
                                    <th>√Åp su·∫•t (hPa)</th>
                                    <th>C√≥ m∆∞a?</th>
                                    <th>ƒê·ªô tin c·∫≠y (%)</th>
                                </tr>
                            </thead>
                            <tbody id="forecastTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 30px;">
                                        <div class="loading"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Comparison Chart -->
            <section class="section">
                <div class="chart-container">
                    <h3 class="chart-title">So s√°nh: Th·ª±c t·∫ø vs D·ª± b√°o (Nhi·ªát ƒë·ªô)</h3>
                    <canvas class="chart-canvas" id="comparisonChart" width="1200" height="400"></canvas>
                </div>
            </section>

            <!-- ML Model Info -->
            <section class="section">
                <h2 class="section-title">Th√¥ng tin model ML</h2>
                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Model ƒëang s·ª≠ d·ª•ng</label>
                        <input type="text" class="form-input" id="modelName" value="Prophet" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">L·∫ßn train g·∫ßn nh·∫•t</label>
                        <input type="text" class="form-input" id="lastTrained" value="--" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">S·ªë d√≤ng d·ªØ li·ªáu ƒë√£ d√πng ƒë·ªÉ train</label>
                        <input type="text" class="form-input" id="dataRows" value="--" disabled>
                    </div>
                    <div class="info-panel">
                        <div class="info-panel-title">üìä Hi·ªáu su·∫•t model</div>
                        <div class="info-panel-content">
                            Model ƒë∆∞·ª£c train tr√™n d·ªØ li·ªáu l·ªãch s·ª≠ t·ª´ MySQL. ƒê·ªô ch√≠nh x√°c d·ª± b√°o ph·ª• thu·ªôc v√†o ch·∫•t l∆∞·ª£ng
                            v√† s·ªë l∆∞·ª£ng d·ªØ li·ªáu training.
                        </div>
                    </div>
                    <div class="mt-20">
                        <button class="btn btn-primary" onclick="simulateTraining()">
                            ü§ñ Gi·∫£ l·∫≠p train l·∫°i model
                        </button>
                    </div>
                    <div id="trainingProgress" class="hidden mt-20">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                        <p style="text-align: center; margin-top: 10px; font-size: 14px;" id="trainingStatus">ƒêang train
                            model...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script src="app.js"></script>
    <script>
        let forecastData = null;

        // Load forecast data
        async function loadForecastData() {
            const tableBody = document.getElementById('forecastTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;"><div class="loading"></div></td></tr>';

            try {
                forecastData = await AppUtils.fetchForecastData();

                // Update summary
                const icon = forecastData.rainProbability ? 'üåßÔ∏è' : '‚òÄÔ∏è';
                document.getElementById('weatherIcon').textContent = icon;
                document.getElementById('forecastSummary').textContent = forecastData.summary;

                if (forecastData.rainProbability) {
                    document.getElementById('forecastDetail').textContent = `X√°c su·∫•t m∆∞a: ${forecastData.rainProbability}%`;
                } else {
                    document.getElementById('forecastDetail').textContent = 'Th·ªùi ti·∫øt ·ªïn ƒë·ªãnh';
                }

                // Update table
                tableBody.innerHTML = '';
                forecastData.forecasts.forEach(forecast => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>${forecast.time}</td>
            <td>${forecast.temperature}¬∞C</td>
            <td>${forecast.humidity}%</td>
            <td>${forecast.pressure} hPa</td>
            <td>${forecast.willRain ? '<span style="color: #4299e1;">‚úì C√≥</span>' : '<span style="color: var(--text-secondary);">‚úó Kh√¥ng</span>'}</td>
            <td>${forecast.confidence}%</td>
          `;
                    tableBody.appendChild(row);
                });

                // Update model info
                document.getElementById('modelName').value = forecastData.modelInfo.name;
                document.getElementById('lastTrained').value = forecastData.modelInfo.lastTrained;
                document.getElementById('dataRows').value = forecastData.modelInfo.dataRows.toLocaleString('vi-VN');

                // Draw comparison chart
                drawComparisonChart();

                AppUtils.showToast('ƒê√£ t·∫£i d·ª± b√°o th√†nh c√¥ng', 'success');
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--danger);">L·ªói: ${error.message}</td></tr>`;
                AppUtils.showToast(error.message, 'error');
            }
        }

        // Draw comparison chart (Actual vs Predicted)
        function drawComparisonChart() {
            const canvas = document.getElementById('comparisonChart');

            // Create dummy actual vs predicted data
            const actualData = [];
            const predictedData = [];

            for (let i = 0; i < 12; i++) {
                const time = new Date(Date.now() + i * 3600000);
                const timeStr = time.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const baseTemp = 28;

                actualData.push({
                    time: timeStr,
                    value: (baseTemp + Math.random() * 4 - 2).toFixed(1)
                });

                predictedData.push({
                    time: timeStr,
                    value: (baseTemp + Math.random() * 3 - 1.5).toFixed(1)
                });
            }

            // Draw actual data
            AppUtils.drawLineChart(canvas, actualData, {
                color: '#ff6b9d',
                padding: 50
            });

            // Overlay predicted data (simplified - just draw on top)
            // In a real implementation, you'd want to draw both lines properly
        }

        // Simulate model training
        async function simulateTraining() {
            const progressDiv = document.getElementById('trainingProgress');
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('trainingStatus');

            progressDiv.classList.remove('hidden');
            progressFill.style.width = '0%';
            statusText.textContent = 'ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...';

            // Simulate progress
            const steps = [
                { progress: 20, text: 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ MySQL...' },
                { progress: 40, text: 'ƒêang ti·ªÅn x·ª≠ l√Ω d·ªØ li·ªáu...' },
                { progress: 60, text: 'ƒêang train model...' },
                { progress: 80, text: 'ƒêang ƒë√°nh gi√° model...' },
                { progress: 100, text: 'Ho√†n th√†nh!' }
            ];

            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, 800));
                progressFill.style.width = step.progress + '%';
                statusText.textContent = step.text;
            }

            setTimeout(() => {
                progressDiv.classList.add('hidden');
                AppUtils.showToast('Train model th√†nh c√¥ng! (gi·∫£ l·∫≠p)', 'success');
            }, 1000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadForecastData();
        });
    </script>
</body>

</html>