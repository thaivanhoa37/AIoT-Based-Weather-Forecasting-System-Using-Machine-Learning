<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi·ªÉu ƒë·ªì & Ph√¢n t√≠ch - AIoT Weather</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="app-logo">
                <span class="logo-icon">üå§Ô∏è</span>
                <div>
                    <div class="app-title">AIoT Weather</div>
                    <div class="app-subtitle">AIoT-ML</div>
                </div>
            </div>
        </div>
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-icon">üè†</span>
                        <span>T·ªïng quan</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="charts.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        <span>Bi·ªÉu ƒë·ªì & Ph√¢n t√≠ch</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="forecast.html" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span>D·ª± b√°o (ML)</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="ml-training.html" class="nav-link">
                        <span class="nav-icon">üöÄ</span>
                        <span>Hu·∫•n luy·ªán ML</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="mysql.html" class="nav-link">
                        <span class="nav-icon">üíæ</span>
                        <span>Qu·∫£n l√Ω d·ªØ li·ªáu MySQL</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>C·∫•u h√¨nh h·ªá th·ªëng</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="hamburger-btn" id="hamburgerBtn">‚ò∞</button>
                <h1 class="page-title">Bi·ªÉu ƒë·ªì & Ph√¢n t√≠ch</h1>
            </div>
            <div class="topbar-right">
                <div class="clock-display">
                    <span class="clock-time" id="clockTime">00:00:00</span>
                    <span class="clock-label">GMT+7</span>
                </div>
                <div class="status-badge connected" id="mysqlStatus">
                    <span class="status-dot"></span> MySQL: Connected
                </div>
                <button class="theme-toggle" id="themeToggle">üåô</button>
            </div>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Filter Panel -->
            <section class="section">
                <div class="filter-panel">
                    <h3 class="section-title">B·ªô l·ªçc d·ªØ li·ªáu</h3>

                    <!-- Quick Time Range Buttons -->
                    <div class="filter-row">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Kho·∫£ng th·ªùi gian nhanh</label>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="setTimeRange('today')" id="btnToday">H√¥m
                                    nay</button>
                                <button class="btn btn-primary" onclick="setTimeRange('24h')" id="btn24h">24 gi·ªù
                                    qua</button>
                                <button class="btn btn-secondary" onclick="setTimeRange('7d')" id="btn7d">7 ng√†y
                                    qua</button>
                                <button class="btn btn-secondary" onclick="setTimeRange('30d')" id="btn30d">30 ng√†y
                                    qua</button>
                                <button class="btn btn-secondary" onclick="setTimeRange('custom')" id="btnCustom">T√πy
                                    ch·ªânh</button>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Date/Time Range -->
                    <div class="filter-row" id="customRangeRow" style="display: none;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">üìÖ T·ª´ ng√†y & gi·ªù</label>
                            <input type="datetime-local" class="form-input" id="startDateTime">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">üìÖ ƒê·∫øn ng√†y & gi·ªù</label>
                            <input type="datetime-local" class="form-input" id="endDateTime">
                        </div>
                    </div>

                    <!-- Node and Granularity -->
                    <div class="filter-row">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Node</label>
                            <select class="form-select" id="nodeSelect">
                                <option value="all">T·∫•t c·∫£</option>
                                <option value="node1">Node 1</option>
                                <option value="node2">Node 2</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">ƒê·ªô chi ti·∫øt hi·ªÉn th·ªã</label>
                            <select class="form-select" id="granularitySelect">
                                <option value="hour">Theo gi·ªù (chi ti·∫øt)</option>
                                <option value="day">Theo ng√†y</option>
                                <option value="week">Theo tu·∫ßn</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="filter-row">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            üîç √Åp d·ª•ng b·ªô l·ªçc
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            üîÑ ƒê·∫∑t l·∫°i
                        </button>
                    </div>

                    <!-- Time Range Info Display -->
                    <div class="info-panel mt-10" id="timeRangeInfo" style="display: none;">
                        <div class="info-panel-content">
                            <strong>‚è±Ô∏è Kho·∫£ng th·ªùi gian ƒëang xem:</strong><br>
                            <span id="timeRangeText"></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- All Sensors Detailed Charts (Combined - No Separation) -->
            <section class="section">
                <h2 class="section-title">üìä T·∫•t c·∫£ c·∫£m bi·∫øn - Xem chi ti·∫øt</h2>
                <p class="section-subtitle">Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu c·∫£m bi·∫øn IoT v√† API th·ªùi ti·∫øt trong m·ªôt giao di·ªán
                    th·ªëng nh·∫•t</p>
                <div id="allSensorsChartsGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
                    <!-- Detailed charts will be populated by JavaScript -->
                </div>
            </section>

            <!-- Statistics Cards -->
            <section class="section">
                <h2 class="section-title">üìà Th·ªëng k√™ t·ªïng h·ª£p</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script src="app.js"></script>
    <script>
        let currentTimeRange = '24h';
        let chartsData = {};
        let customStartDate = null;
        let customEndDate = null;
        let currentGranularity = 'hour';

        // All sensors configuration (IoT + Weather API - NO SEPARATION)
        const allSensors = [
            { key: 'temperature', name: 'Nhi·ªát ƒë·ªô', unit: '¬∞C', color: '#ff6b9d', icon: 'üå°Ô∏è' },
            { key: 'humidity', name: 'ƒê·ªô ·∫©m', unit: '%', color: '#4299e1', icon: 'üíß' },
            { key: 'pressure', name: '√Åp su·∫•t', unit: 'hPa', color: '#f6ad55', icon: 'üéØ' },
            { key: 'co2', name: 'CO‚ÇÇ', unit: 'ppm', color: '#68d391', icon: '‚òÅÔ∏è' },
            { key: 'dust', name: 'B·ª•i m·ªãn', unit: '¬µg/m¬≥', color: '#b794f4', icon: 'üò∑' },
            { key: 'windSpeed', name: 'T·ªëc ƒë·ªô gi√≥', unit: 'km/h', color: '#90cdf4', icon: 'üå¨Ô∏è' },
            { key: 'rainfall', name: 'L∆∞·ª£ng m∆∞a', unit: 'mm', color: '#63b3ed', icon: 'üåßÔ∏è' },
            { key: 'uvIndex', name: 'Ch·ªâ s·ªë UV', unit: '', color: '#fbd38d', icon: '‚òÄÔ∏è' }
        ];

        // Initialize datetime inputs
        function initializeDateTimeInputs() {
            const now = new Date();
            const endDateTime = document.getElementById('endDateTime');
            const startDateTime = document.getElementById('startDateTime');

            endDateTime.value = formatDateTimeLocal(now);
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            startDateTime.value = formatDateTimeLocal(yesterday);
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Set time range
        function setTimeRange(range) {
            currentTimeRange = range;

            const buttons = ['btnToday', 'btn24h', 'btn7d', 'btn30d', 'btnCustom'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.className = 'btn btn-secondary';
            });

            const btnMap = {
                'today': 'btnToday',
                '24h': 'btn24h',
                '7d': 'btn7d',
                '30d': 'btn30d',
                'custom': 'btnCustom'
            };

            const selectedBtn = document.getElementById(btnMap[range]);
            if (selectedBtn) selectedBtn.className = 'btn btn-primary';

            const customRow = document.getElementById('customRangeRow');
            customRow.style.display = range === 'custom' ? 'flex' : 'none';
        }

        // Reset filters
        function resetFilters() {
            setTimeRange('24h');
            document.getElementById('nodeSelect').value = 'all';
            document.getElementById('granularitySelect').value = 'hour';
            document.getElementById('timeRangeInfo').style.display = 'none';
            applyFilters();
        }

        // Apply filters
        async function applyFilters() {
            currentGranularity = document.getElementById('granularitySelect').value;

            if (currentTimeRange === 'custom') {
                const startInput = document.getElementById('startDateTime').value;
                const endInput = document.getElementById('endDateTime').value;

                if (!startInput || !endInput) {
                    AppUtils.showToast('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y gi·ªù b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c', 'warning');
                    return;
                }

                customStartDate = new Date(startInput);
                customEndDate = new Date(endInput);

                if (customStartDate >= customEndDate) {
                    AppUtils.showToast('Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ng√†y k·∫øt th√∫c', 'error');
                    return;
                }

                const infoPanel = document.getElementById('timeRangeInfo');
                const infoText = document.getElementById('timeRangeText');
                infoPanel.style.display = 'block';
                infoText.innerHTML = `
                    <strong>T·ª´:</strong> ${customStartDate.toLocaleString('vi-VN')}<br>
                    <strong>ƒê·∫øn:</strong> ${customEndDate.toLocaleString('vi-VN')}<br>
                    <strong>T·ªïng:</strong> ${Math.round((customEndDate - customStartDate) / (1000 * 60 * 60))} gi·ªù
                `;
            } else {
                document.getElementById('timeRangeInfo').style.display = 'none';
            }

            await loadChartsData();
        }

        // Generate weather API data
        function generateWeatherAPIData(sensorKey, dataPoints) {
            const data = [];
            let baseValue;

            switch (sensorKey) {
                case 'windSpeed': baseValue = 12; break;
                case 'rainfall': baseValue = 2; break;
                case 'uvIndex': baseValue = 5; break;
                default: baseValue = 10;
            }

            for (let i = 0; i < dataPoints; i++) {
                const variation = (Math.random() - 0.5) * (baseValue * 0.4);
                const value = Math.max(0, baseValue + variation);
                const timestamp = new Date(Date.now() - (dataPoints - i) * 3600000);

                const dateStr = timestamp.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const timeStr = timestamp.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                data.push({
                    time: `${dateStr} ${timeStr}`,
                    timestamp: timestamp,
                    value: value.toFixed(1)
                });
            }

            return data;
        }

        // Load all charts data
        async function loadChartsData() {
            const grid = document.getElementById('allSensorsChartsGrid');
            const loading = AppUtils.showLoading(grid);

            try {
                // Fetch IoT sensor data
                const iotSensorKeys = ['temperature', 'humidity', 'pressure', 'co2', 'dust'];
                const iotData = await AppUtils.fetchChartsData(currentTimeRange, iotSensorKeys);

                // Generate Weather API data
                const dataPoints = currentTimeRange === '24h' ? 24 : currentTimeRange === '7d' ? 168 : currentTimeRange === '30d' ? 720 : 48;

                chartsData = { ...iotData };
                chartsData.windSpeed = generateWeatherAPIData('windSpeed', dataPoints);
                chartsData.rainfall = generateWeatherAPIData('rainfall', dataPoints);
                chartsData.uvIndex = generateWeatherAPIData('uvIndex', dataPoints);

                // Draw all detailed charts
                drawAllDetailedCharts();

                // Update statistics
                updateStatistics();

                AppUtils.showToast('ƒê√£ c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì th√†nh c√¥ng', 'success');
            } catch (error) {
                AppUtils.showToast(error.message, 'error');
            } finally {
                AppUtils.hideLoading(loading);
            }
        }

        // Draw all detailed charts in unified grid
        function drawAllDetailedCharts() {
            const grid = document.getElementById('allSensorsChartsGrid');
            grid.innerHTML = '';

            allSensors.forEach(sensor => {
                // Create chart container
                const container = document.createElement('div');
                container.className = 'chart-container';

                // Create header with title and current value
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.marginBottom = '15px';

                const title = document.createElement('h3');
                title.className = 'chart-title';
                title.innerHTML = `${sensor.icon} ${sensor.name}`;
                title.style.margin = '0';
                title.style.fontSize = '16px';

                // Current value display
                const valueDisplay = document.createElement('div');
                valueDisplay.style.textAlign = 'right';

                if (chartsData[sensor.key] && chartsData[sensor.key].length > 0) {
                    const latest = chartsData[sensor.key][chartsData[sensor.key].length - 1];
                    const currentVal = document.createElement('div');
                    currentVal.style.fontSize = '24px';
                    currentVal.style.fontWeight = 'bold';
                    currentVal.style.color = sensor.color;
                    currentVal.textContent = `${latest.value} ${sensor.unit}`;

                    const updateTime = document.createElement('div');
                    updateTime.style.fontSize = '11px';
                    updateTime.style.color = 'var(--text-secondary)';
                    updateTime.textContent = `C·∫≠p nh·∫≠t: ${latest.time.split(' ')[1]}`;

                    valueDisplay.appendChild(currentVal);
                    valueDisplay.appendChild(updateTime);
                }

                header.appendChild(title);
                header.appendChild(valueDisplay);

                // Create canvas for chart
                const canvas = document.createElement('canvas');
                canvas.width = 700;
                canvas.height = 280;
                canvas.style.width = '100%';
                canvas.style.height = 'auto';

                container.appendChild(header);
                container.appendChild(canvas);
                grid.appendChild(container);

                // Draw chart
                if (chartsData[sensor.key]) {
                    AppUtils.drawLineChart(canvas, chartsData[sensor.key], {
                        color: sensor.color,
                        padding: 60
                    });
                }
            });
        }

        // Update statistics
        function updateStatistics() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            allSensors.forEach(sensor => {
                if (!chartsData[sensor.key]) return;

                const values = chartsData[sensor.key].map(d => parseFloat(d.value));
                const min = Math.min(...values).toFixed(1);
                const max = Math.max(...values).toFixed(1);
                const avg = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);

                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-label">${sensor.icon} ${sensor.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        <div>Min: <strong>${min} ${sensor.unit}</strong></div>
                        <div>Max: <strong>${max} ${sensor.unit}</strong></div>
                        <div>Avg: <strong>${avg} ${sensor.unit}</strong></div>
                    </div>
                `;
                statsGrid.appendChild(statCard);
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateTimeInputs();
            loadChartsData();
        });
    </script>
</body>

</html>