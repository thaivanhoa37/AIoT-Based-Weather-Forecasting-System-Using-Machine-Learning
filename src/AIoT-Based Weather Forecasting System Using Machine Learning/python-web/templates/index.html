{% extends "base.html" %}

{% block title %}T·ªïng quan - AIoT Weather{% endblock %}
{% block page_title %}T·ªïng quan th·ªùi ti·∫øt{% endblock %}

{% block content %}
<!-- Current Weather Overview -->
<section class="section">
    <div class="weather-hero">
        <div class="hero-content">
            <div class="current-temp-display">
                <div class="current-temp" id="currentTemp">--¬∞C</div>
                <div class="weather-description" id="weatherDesc">ƒêang t·∫£i...</div>
            </div>
            <div class="hero-info">
                <div class="info-item">
                    <span class="info-label">üíß ƒê·ªô ·∫©m</span>
                    <span class="info-value" id="heroHumidity">--%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">üí® Gi√≥</span>
                    <span class="info-value" id="heroWind">--km/h</span>
                </div>
                <div class="info-item">
                    <span class="info-label">‚è±Ô∏è √Åp su·∫•t</span>
                    <span class="info-value" id="heroPressure">--hPa</span>
                </div>
            </div>
        </div>
        <div class="location-info">
            <span id="locationDisplay">üìç Qu·∫≠n 9, TP.HCM</span>
            <span class="last-update" id="lastUpdate">C·∫≠p nh·∫≠t l√∫c --</span>
        </div>
    </div>
</section>

<!-- Real-time IoT Sensor Data -->
<section class="section">
    <h2 class="section-title">üì° D·ªØ li·ªáu c·∫£m bi·∫øn IoT (Th·ªùi gian th·ª±c)</h2>
    <div class="cards-grid" id="iotDataCards">
        <div class="card">
            <div class="card-header">
                <div class="card-icon temp">üå°Ô∏è</div>
                <div class="card-label">Nhi·ªát ƒë·ªô</div>
            </div>
            <div class="card-value" id="tempValue">--<span class="card-unit">¬∞C</span></div>
            <div class="card-footer" id="tempTime">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon humidity">üíß</div>
                <div class="card-label">ƒê·ªô ·∫©m</div>
            </div>
            <div class="card-value" id="humidityValue">--<span class="card-unit">%</span></div>
            <div class="card-footer" id="humidityTime">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon pressure">‚è±Ô∏è</div>
                <div class="card-label">√Åp su·∫•t</div>
            </div>
            <div class="card-value" id="pressureValue">--<span class="card-unit">hPa</span></div>
            <div class="card-footer" id="pressureTime">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon co2">üí®</div>
                <div class="card-label">CO‚ÇÇ</div>
            </div>
            <div class="card-value" id="co2Value">--<span class="card-unit">ppm</span></div>
            <div class="card-footer" id="co2Time">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon dust">üå´Ô∏è</div>
                <div class="card-label">B·ª•i m·ªãn</div>
            </div>
            <div class="card-value" id="dustValue">--<span class="card-unit">¬µg/m¬≥</span></div>
            <div class="card-footer" id="dustTime">ƒêang t·∫£i...</div>
        </div>
    </div>
    <div class="text-center mt-10">
        <button class="btn btn-primary" onclick="loadRealtimeData()">
            üîÑ C·∫≠p nh·∫≠t d·ªØ li·ªáu
        </button>
    </div>
</section>

<!-- Weather API Data -->
<section class="section">
    <h2 class="section-title">üåç D·ªØ li·ªáu t·ª´ API Th·ªùi ti·∫øt</h2>
    <div class="cards-grid" id="weatherApiCards">
        <div class="card">
            <div class="card-header">
                <div class="card-icon wind">üå¨Ô∏è</div>
                <div class="card-label">T·ªëc ƒë·ªô gi√≥</div>
            </div>
            <div class="card-value" id="windSpeedValue">--<span class="card-unit">km/h</span></div>
            <div class="card-footer">Gi√≥</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon rain">üåßÔ∏è</div>
                <div class="card-label">L∆∞·ª£ng m∆∞a</div>
            </div>
            <div class="card-value" id="rainfallValue">--<span class="card-unit">mm</span></div>
            <div class="card-footer">M∆∞a</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon uv">‚òÄÔ∏è</div>
                <div class="card-label">Ch·ªâ s·ªë UV</div>
            </div>
            <div class="card-value" id="uvValue">--</div>
            <div class="card-footer" id="uvLevel">--</div>
        </div>
    </div>
</section>

<!-- 7-Day Weather Forecast -->
<section class="section">
    <h2 class="section-title">üìÖ D·ª± b√°o 7 ng√†y (ML Model)</h2>
    <p class="section-subtitle">D·ª± b√°o th·ªùi ti·∫øt t·ª´ model Prophet ƒë√£ hu·∫•n luy·ªán</p>
    <div class="forecast-scroll-container" id="forecast7DayContainer">
        <div class="forecast-grid-7day-scroll" id="forecast7DayGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</section>

<!-- Today Hourly Forecast -->
<section class="section">
    <h2 class="section-title">üìà D·ª± b√°o theo gi·ªù - 24 gi·ªù (ML Model)</h2>
    <p class="section-subtitle">D·ª± b√°o chi ti·∫øt t·ª´ng gi·ªù trong 24 gi·ªù t·ªõi t·ª´ model ML</p>
    <div class="forecast-scroll-container">
        <div class="forecast-grid-hourly" id="forecastHourlyGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</section>

<!-- System Status -->
<section class="section">
    <h2 class="section-title">‚öôÔ∏è Tr·∫°ng th√°i h·ªá th·ªëng</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üì°</div>
            <div class="stat-label">C·∫£m bi·∫øn ho·∫°t ƒë·ªông</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">S·ªë l∆∞·ª£ng</span>
                    <span class="stat-value-small" id="activeSensors">5</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üíæ</div>
            <div class="stat-label">B·∫£n ghi d·ªØ li·ªáu</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">H√¥m nay</span>
                    <span class="stat-value-small" id="recordsToday">--</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚è∞</div>
            <div class="stat-label">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">Th·ªùi gian</span>
                    <span class="stat-value-small" id="lastDataTime">--</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úì</div>
            <div class="stat-label">Tr·∫°ng th√°i</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">H·ªá th·ªëng</span>
                    <span class="stat-value-small" style="color: #48bb78;" id="systemStatus">Ho·∫°t ƒë·ªông</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Page-specific JavaScript
    let trendData = {
        temperature: [],
        humidity: [],
        co2: [],
        dust: []
    };

    // Load 7-day forecast from ML model
    async function loadForecast7Day() {
        const grid = document.getElementById('forecast7DayGrid');
        grid.innerHTML = '<div class="loading-text">ƒêang t·∫£i d·ª± b√°o t·ª´ ML model...</div>';
        
        try {
            const response = await fetch('/api/ml/predict?hours_ahead=168');
            if (!response.ok) throw new Error('Failed to fetch forecast');
            const data = await response.json();
            
            if (!data.forecasts || data.forecasts.length === 0) {
                throw new Error('No forecast data');
            }
            
            // Group forecasts by day
            const dailyForecasts = {};
            data.forecasts.forEach(forecast => {
                const date = forecast.timestamp.split(' ')[0]; // Get date part
                if (!dailyForecasts[date]) {
                    dailyForecasts[date] = [];
                }
                dailyForecasts[date].push(forecast);
            });
            
            // Calculate daily averages
            const days = Object.keys(dailyForecasts).slice(0, 7);
            grid.innerHTML = '';
            
            days.forEach((date, index) => {
                const dayData = dailyForecasts[date];
                const temps = dayData.map(d => d.temperature);
                const humidities = dayData.map(d => d.humidity);
                const rainCount = dayData.filter(d => d.willRain).length;
                
                const tempMax = Math.max(...temps);
                const tempMin = Math.min(...temps);
                const avgHumidity = humidities.reduce((a, b) => a + b, 0) / humidities.length;
                const rainChance = (rainCount / dayData.length) * 100;
                
                // Get weather icon based on conditions
                let icon = '‚òÄÔ∏è';
                let condition = 'N·∫Øng';
                if (rainChance > 60) {
                    icon = 'üåßÔ∏è';
                    condition = 'M∆∞a';
                } else if (rainChance > 30) {
                    icon = '‚õÖ';
                    condition = 'C√≥ m√¢y';
                } else if (avgHumidity > 80) {
                    icon = '‚òÅÔ∏è';
                    condition = 'Nhi·ªÅu m√¢y';
                }
                
                // Parse date
                const [day, month, year] = date.split('/');
                const dateObj = new Date(year, month - 1, day);
                const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                const dayName = dayNames[dateObj.getDay()];
                
                const card = document.createElement('div');
                card.className = 'forecast-card-7day';
                if (index === 0) card.classList.add('today');
                
                card.innerHTML = `
                    <div class="forecast-date">${dayName}, ${day}/${month}</div>
                    <div class="forecast-icon" style="font-size: 32px;">${icon}</div>
                    <div class="forecast-condition">${condition}</div>
                    <div class="forecast-temp">
                        <span class="temp-max">${tempMax.toFixed(0)}¬∞</span>
                        <span class="temp-min">${tempMin.toFixed(0)}¬∞</span>
                    </div>
                    <div class="forecast-details">
                        <span>üíß ${avgHumidity.toFixed(0)}%</span>
                    </div>
                    <div class="forecast-rain">‚òî ${rainChance.toFixed(0)}%</div>
                `;
                grid.appendChild(card);
            });
            
            // Add scroll buttons for 7-day forecast
            addScrollButtonsFor7Day();
            
        } catch (error) {
            console.error('Error loading 7-day forecast:', error);
            grid.innerHTML = '<div class="error-text">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ª± b√°o. Vui l√≤ng train model tr∆∞·ªõc.</div>';
        }
    }

    // Load hourly forecast from ML model
    async function loadForecastHourly() {
        const grid = document.getElementById('forecastHourlyGrid');
        grid.innerHTML = '<div class="loading-text">ƒêang t·∫£i d·ª± b√°o...</div>';
        
        try {
            const response = await fetch('/api/ml/predict?hours_ahead=24');
            if (!response.ok) throw new Error('Failed to fetch forecast');
            const data = await response.json();
            
            if (!data.forecasts || data.forecasts.length === 0) {
                throw new Error('No forecast data');
            }
            
            grid.innerHTML = '';
            const currentHour = new Date().getHours();
            
            data.forecasts.forEach((forecast, index) => {
                // Parse time from timestamp
                const timePart = forecast.time || forecast.timestamp.split(' ')[1];
                const hour = parseInt(timePart.split(':')[0]);
                
                // Get weather icon
                let icon = '‚òÄÔ∏è';
                let condition = 'N·∫Øng';
                if (forecast.willRain) {
                    icon = 'üåßÔ∏è';
                    condition = 'M∆∞a';
                } else if (forecast.humidity > 80) {
                    icon = '‚òÅÔ∏è';
                    condition = 'M√¢y';
                } else if (hour >= 18 || hour < 6) {
                    icon = 'üåô';
                    condition = 'ƒê√™m';
                }
                
                const card = document.createElement('div');
                card.className = 'forecast-card-hourly';
                if (index === 0) card.classList.add('current-hour');
                
                card.innerHTML = `
                    <div class="forecast-hour">${timePart.substring(0, 5)}</div>
                    <div class="forecast-icon" style="font-size: 28px;">${icon}</div>
                    <div class="forecast-temp-main">${forecast.temperature.toFixed(0)}¬∞C</div>
                    <div class="forecast-condition-small">${condition}</div>
                    <div class="forecast-details-small">
                        <span>üíß ${forecast.humidity.toFixed(0)}%</span>
                    </div>
                    <div class="forecast-details-small">
                        <span>üìä ${forecast.confidence.toFixed(0)}%</span>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            addScrollButtons();
            
        } catch (error) {
            console.error('Error loading hourly forecast:', error);
            grid.innerHTML = '<div class="error-text">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ª± b√°o theo gi·ªù.</div>';
        }
    }

    function addScrollButtons() {
        const container = document.querySelector('.forecast-scroll-container');
        if (!container) return;

        const existingBtn = container.querySelectorAll('.scroll-btn');
        existingBtn.forEach(btn => btn.remove());

        const leftBtn = document.createElement('button');
        leftBtn.className = 'scroll-btn scroll-left';
        leftBtn.innerHTML = '‚ùÆ';
        leftBtn.onclick = () => {
            const grid = document.getElementById('forecastHourlyGrid');
            grid.parentElement.scrollBy({ left: -300, behavior: 'smooth' });
        };

        const rightBtn = document.createElement('button');
        rightBtn.className = 'scroll-btn scroll-right';
        rightBtn.innerHTML = '‚ùØ';
        rightBtn.onclick = () => {
            const grid = document.getElementById('forecastHourlyGrid');
            grid.parentElement.scrollBy({ left: 300, behavior: 'smooth' });
        };

        container.appendChild(leftBtn);
        container.appendChild(rightBtn);
    }

    function addScrollButtonsFor7Day() {
        const container = document.getElementById('forecast7DayContainer');
        if (!container) return;

        const existingBtn = container.querySelectorAll('.scroll-btn');
        existingBtn.forEach(btn => btn.remove());

        const leftBtn = document.createElement('button');
        leftBtn.className = 'scroll-btn scroll-left';
        leftBtn.innerHTML = '‚ùÆ';
        leftBtn.onclick = () => {
            const grid = document.getElementById('forecast7DayGrid');
            grid.scrollBy({ left: -200, behavior: 'smooth' });
        };

        const rightBtn = document.createElement('button');
        rightBtn.className = 'scroll-btn scroll-right';
        rightBtn.innerHTML = '‚ùØ';
        rightBtn.onclick = () => {
            const grid = document.getElementById('forecast7DayGrid');
            grid.scrollBy({ left: 200, behavior: 'smooth' });
        };

        container.appendChild(leftBtn);
        container.appendChild(rightBtn);
    }

    // Load realtime data using API
    async function loadRealtimeData() {
        const cards = document.getElementById('iotDataCards');
        const loading = AppUtils.showLoading(cards);

        try {
            // Fetch from API endpoint
            const response = await fetch('/api/realtime-data');
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.json();

            // Update hero section
            document.getElementById('currentTemp').textContent = `${data.temperature}¬∞C`;
            document.getElementById('weatherDesc').textContent = 'Th·ªùi ti·∫øt hi·ªán t·∫°i';
            document.getElementById('heroHumidity').textContent = `${data.humidity}%`;
            document.getElementById('heroWind').textContent = `${data.wind_speed}km/h`;
            document.getElementById('heroPressure').textContent = `${data.pressure}hPa`;
            document.getElementById('lastUpdate').textContent = `C·∫≠p nh·∫≠t l√∫c ${data.timestamp}`;

            // Update IoT data cards
            document.getElementById('tempValue').innerHTML = `${data.temperature}<span class="card-unit">¬∞C</span>`;
            document.getElementById('humidityValue').innerHTML = `${data.humidity}<span class="card-unit">%</span>`;
            document.getElementById('pressureValue').innerHTML = `${data.pressure}<span class="card-unit">hPa</span>`;
            document.getElementById('co2Value').innerHTML = `${data.co2}<span class="card-unit">ppm</span>`;
            document.getElementById('dustValue').innerHTML = `${data.dust}<span class="card-unit">¬µg/m¬≥</span>`;

            // Update timestamps
            const timestamp = `C·∫≠p nh·∫≠t: ${data.timestamp}`;
            document.getElementById('tempTime').textContent = timestamp;
            document.getElementById('humidityTime').textContent = timestamp;
            document.getElementById('pressureTime').textContent = timestamp;
            document.getElementById('co2Time').textContent = timestamp;
            document.getElementById('dustTime').textContent = timestamp;

            // Update weather API data
            document.getElementById('windSpeedValue').innerHTML = `${data.wind_speed}<span class="card-unit">km/h</span>`;
            document.getElementById('rainfallValue').innerHTML = `${data.rainfall}<span class="card-unit">mm</span>`;
            document.getElementById('uvValue').textContent = data.uv_index;
            document.getElementById('uvLevel').textContent = AppUtils.getUVLevel(data.uv_index);

            // Update system status via API
            const statsResponse = await fetch('/api/system-stats');
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                document.getElementById('lastDataTime').textContent = stats.last_update;
                document.getElementById('recordsToday').textContent = stats.records_today;
                document.getElementById('activeSensors').textContent = stats.active_sensors;
            }

            AppUtils.showToast('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu th√†nh c√¥ng', 'success');
        } catch (error) {
            console.error('Error loading data:', error);
            AppUtils.showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        } finally {
            AppUtils.hideLoading(loading);
        }
    }

    // Load location settings
    async function loadLocationSettings() {
        try {
            const settingsResponse = await fetch('/api/settings');
            if (settingsResponse.ok) {
                const settings = await settingsResponse.json();
                if (settings.location && settings.location.name) {
                    document.getElementById('locationDisplay').textContent = `üìç ${settings.location.name}`;
                    localStorage.setItem('locationName', settings.location.name);
                } else {
                    const savedLocation = localStorage.getItem('locationName');
                    if (savedLocation) {
                        document.getElementById('locationDisplay').textContent = `üìç ${savedLocation}`;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading location:', error);
            // Use saved location from localStorage
            const savedLocation = localStorage.getItem('locationName');
            if (savedLocation) {
                document.getElementById('locationDisplay').textContent = `üìç ${savedLocation}`;
            }
        }
    }

    // Listen for location updates from settings page
    window.addEventListener('locationUpdated', (event) => {
        const { name } = event.detail;
        document.getElementById('locationDisplay').textContent = `üìç ${name}`;
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadLocationSettings();
        loadRealtimeData();
        loadForecast7Day();
        loadForecastHourly();

        // Auto-refresh every 30 seconds
        setInterval(loadRealtimeData, 30000);
        
        // Refresh forecasts every 5 minutes
        setInterval(() => {
            loadForecast7Day();
            loadForecastHourly();
        }, 300000);
    });
</script>

<script src="/static/js/index.js"></script>
{% endblock %}