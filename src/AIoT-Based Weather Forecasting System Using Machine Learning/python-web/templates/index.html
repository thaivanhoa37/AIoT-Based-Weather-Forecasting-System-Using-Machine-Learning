{% extends "base.html" %}

{% block title %}T·ªïng quan - AIoT Weather{% endblock %}
{% block page_title %}<span data-i18n="index.pageTitle">T·ªïng quan th·ªùi ti·∫øt</span>{% endblock %}

{% block extra_css %}
<style>
    /* Forecast Grid Container - Scroll horizontal (nh∆∞ trang forecast) */
    .forecast-grid-container {
        overflow-x: auto;
        overflow-y: hidden;
        margin-bottom: 20px;
        padding-bottom: 10px;
        scroll-behavior: smooth;
        position: relative;
    }

    .forecast-grid-container::-webkit-scrollbar {
        height: 8px;
    }

    .forecast-grid-container::-webkit-scrollbar-track {
        background: var(--border-color);
        border-radius: 10px;
    }

    .forecast-grid-container::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }

    .forecast-grid-container::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-color);
    }

    /* Forecast Grid */
    .forecast-grid {
        display: grid;
        grid-template-columns: repeat(24, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 0;
        width: max-content;
    }

    /* Forecast Card */
    .forecast-card {
        background: linear-gradient(135deg, var(--card-bg) 0%, rgba(100, 150, 200, 0.05) 100%);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        min-width: 140px;
    }

    .forecast-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }

    .forecast-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        border-color: var(--primary-color);
    }

    .forecast-card:hover::before {
        transform: translateX(0);
    }

    .forecast-time {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
        font-weight: 600;
    }

    .forecast-icon {
        font-size: 32px;
        margin: 8px 0;
        display: block;
    }

    .forecast-temp {
        font-size: 22px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 6px 0;
    }

    .forecast-details {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 6px;
        line-height: 1.3;
    }

    .confidence-badge {
        display: inline-block;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 700;
    }

    .rain-indicator {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-top: 6px;
    }

    .rain-yes {
        background: #fed7d7;
        color: #c53030;
        font-weight: 600;
    }

    .rain-no {
        background: #c6f6d5;
        color: #22543d;
        font-weight: 600;
    }

    /* Animation */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Scroll buttons */
    .scroll-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        z-index: 10;
        font-size: 16px;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }

    .scroll-btn:hover {
        opacity: 1;
    }

    .scroll-left {
        left: 5px;
    }

    .scroll-right {
        right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Current Weather Overview -->
<section class="section">
    <div class="weather-hero">
        <div class="hero-content">
            <div class="current-temp-display">
                <div class="current-temp" id="currentTemp">--¬∞C</div>
                <div class="weather-description" id="weatherDesc" data-i18n="common.loading">ƒêang t·∫£i...</div>
            </div>
            <div class="hero-info">
                <div class="info-item">
                    <span class="info-label">üíß <span data-i18n="index.humidity">ƒê·ªô ·∫©m</span></span>
                    <span class="info-value" id="heroHumidity">--%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">üí® <span data-i18n="index.wind">Gi√≥</span></span>
                    <span class="info-value" id="heroWind">--km/h</span>
                </div>
                <div class="info-item">
                    <span class="info-label">‚è±Ô∏è <span data-i18n="index.pressure">√Åp su·∫•t</span></span>
                    <span class="info-value" id="heroPressure">--hPa</span>
                </div>
            </div>
        </div>
        <div class="location-info">
            <span id="locationDisplay">üìç <span data-i18n="index.location">Qu·∫≠n 9, TP.HCM</span></span>
            <span class="last-update" id="lastUpdate"><span data-i18n="index.lastUpdate">C·∫≠p nh·∫≠t l√∫c</span> --</span>
        </div>
    </div>
</section>

<!-- Real-time IoT Sensor Data -->
<section class="section">
    <h2 class="section-title">üì° <span data-i18n="index.iotSensorData">D·ªØ li·ªáu c·∫£m bi·∫øn IoT (Th·ªùi gian th·ª±c)</span></h2>
    <div class="cards-grid" id="iotDataCards">
        <div class="card">
            <div class="card-header">
                <div class="card-icon temp">üå°Ô∏è</div>
                <div class="card-label" data-i18n="index.temperature">Nhi·ªát ƒë·ªô</div>
            </div>
            <div class="card-value" id="tempValue">--<span class="card-unit">¬∞C</span></div>
            <div class="card-footer" id="tempTime" data-i18n="common.loading">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon humidity">üíß</div>
                <div class="card-label" data-i18n="index.humidity">ƒê·ªô ·∫©m</div>
            </div>
            <div class="card-value" id="humidityValue">--<span class="card-unit">%</span></div>
            <div class="card-footer" id="humidityTime" data-i18n="common.loading">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon pressure">‚è±Ô∏è</div>
                <div class="card-label" data-i18n="index.pressure">√Åp su·∫•t</div>
            </div>
            <div class="card-value" id="pressureValue">--<span class="card-unit">hPa</span></div>
            <div class="card-footer" id="pressureTime" data-i18n="common.loading">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon co2">üí®</div>
                <div class="card-label" data-i18n="index.co2">CO‚ÇÇ</div>
            </div>
            <div class="card-value" id="co2Value">--<span class="card-unit">ppm</span></div>
            <div class="card-footer" id="co2Time" data-i18n="common.loading">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon dust">üå´Ô∏è</div>
                <div class="card-label" data-i18n="index.dust">B·ª•i m·ªãn</div>
            </div>
            <div class="card-value" id="dustValue">--<span class="card-unit">¬µg/m¬≥</span></div>
            <div class="card-footer" id="dustTime" data-i18n="common.loading">ƒêang t·∫£i...</div>
        </div>
    </div>
    <div class="text-center mt-10">
        <button class="btn btn-primary" onclick="loadRealtimeData()">
            üîÑ <span data-i18n="common.refresh">C·∫≠p nh·∫≠t d·ªØ li·ªáu</span>
        </button>
    </div>
</section>

<!-- Weather API Data -->
<section class="section">
    <h2 class="section-title">üåç <span data-i18n="index.weatherApiData">D·ªØ li·ªáu t·ª´ API Th·ªùi ti·∫øt</span></h2>
    <div class="cards-grid" id="weatherApiCards">
        <div class="card">
            <div class="card-header">
                <div class="card-icon wind">üå¨Ô∏è</div>
                <div class="card-label" data-i18n="index.windSpeed">T·ªëc ƒë·ªô gi√≥</div>
            </div>
            <div class="card-value" id="windSpeedValue">--<span class="card-unit">km/h</span></div>
            <div class="card-footer" data-i18n="index.wind">Gi√≥</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon rain">üåßÔ∏è</div>
                <div class="card-label" data-i18n="index.rainfall">L∆∞·ª£ng m∆∞a</div>
            </div>
            <div class="card-value" id="rainfallValue">--<span class="card-unit">mm</span></div>
            <div class="card-footer" data-i18n="forecast.rain">M∆∞a</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon uv">‚òÄÔ∏è</div>
                <div class="card-label" data-i18n="index.uvIndex">Ch·ªâ s·ªë UV</div>
            </div>
            <div class="card-value" id="uvValue">--</div>
            <div class="card-footer" id="uvLevel">--</div>
        </div>
    </div>
</section>

<!-- 7-Day Weather Forecast -->
<section class="section">
    <h2 class="section-title">üìÖ <span data-i18n="index.forecast7Days">D·ª± b√°o 7 ng√†y (ML Model)</span></h2>
    <p class="section-subtitle" data-i18n="index.forecast7DaysDesc">D·ª± b√°o th·ªùi ti·∫øt t·ª´ model ƒë√£ hu·∫•n luy·ªán</p>
    <div class="forecast-scroll-container" id="forecast7DayContainer">
        <div class="forecast-grid-7day-scroll" id="forecast7DayGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</section>

<!-- Today Hourly Forecast -->
<section class="section">
    <h2 class="section-title">üìà <span data-i18n="index.forecastHourly">D·ª± b√°o 24 gi·ªù t·ªõi (ML Model)</span></h2>
    <p class="section-subtitle" data-i18n="index.forecastHourlyDesc">D·ª± b√°o chi ti·∫øt t·ª´ng gi·ªù trong 24 gi·ªù t·ªõi t·ª´ model ML</p>
    <div class="forecast-grid-container">
        <div class="forecast-grid" id="forecastHourlyGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</section>

<!-- System Status -->
<section class="section">
    <h2 class="section-title">‚öôÔ∏è <span data-i18n="index.systemStatus">Tr·∫°ng th√°i h·ªá th·ªëng</span></h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üì°</div>
            <div class="stat-label" data-i18n="index.activeSensors">C·∫£m bi·∫øn ho·∫°t ƒë·ªông</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small" data-i18n="index.quantity">S·ªë l∆∞·ª£ng</span>
                    <span class="stat-value-small" id="activeSensors">5</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üíæ</div>
            <div class="stat-label" data-i18n="index.dataRecords">B·∫£n ghi d·ªØ li·ªáu</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small" data-i18n="index.todayRecords">H√¥m nay</span>
                    <span class="stat-value-small" id="recordsToday">--</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚è∞</div>
            <div class="stat-label" data-i18n="index.lastUpdateTime">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small" data-i18n="index.time">Th·ªùi gian</span>
                    <span class="stat-value-small" id="lastDataTime">--</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úì</div>
            <div class="stat-label" data-i18n="index.status">Tr·∫°ng th√°i</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small" data-i18n="index.system">H·ªá th·ªëng</span>
                    <span class="stat-value-small" style="color: #48bb78;" id="systemStatus" data-i18n="common.active">Ho·∫°t ƒë·ªông</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Page-specific JavaScript
    let trendData = {
        temperature: [],
        humidity: [],
        co2: [],
        dust: []
    };

    // Load 7-day forecast from ML model
    async function loadForecast7Day() {
        const grid = document.getElementById('forecast7DayGrid');
        grid.innerHTML = '<div class="loading-text">ƒêang t·∫£i d·ª± b√°o t·ª´ ML model...</div>';
        
        try {
            const response = await fetch('/api/ml/predict?hours_ahead=168');
            if (!response.ok) throw new Error('Failed to fetch forecast');
            const data = await response.json();
            
            if (!data.forecasts || data.forecasts.length === 0) {
                throw new Error('No forecast data');
            }
            
            // Group forecasts by day
            const dailyForecasts = {};
            data.forecasts.forEach(forecast => {
                const date = forecast.timestamp.split(' ')[0]; // Get date part
                if (!dailyForecasts[date]) {
                    dailyForecasts[date] = [];
                }
                dailyForecasts[date].push(forecast);
            });
            
            // Calculate daily averages
            const days = Object.keys(dailyForecasts).slice(0, 7);
            grid.innerHTML = '';
            
            days.forEach((date, index) => {
                const dayData = dailyForecasts[date];
                const temps = dayData.map(d => d.temperature);
                const humidities = dayData.map(d => d.humidity);
                const rainCount = dayData.filter(d => d.willRain).length;
                
                const tempMax = Math.max(...temps);
                const tempMin = Math.min(...temps);
                const avgHumidity = humidities.reduce((a, b) => a + b, 0) / humidities.length;
                const rainChance = (rainCount / dayData.length) * 100;
                
                // Get weather icon based on conditions
                let icon = '‚òÄÔ∏è';
                let condition = 'N·∫Øng';
                if (rainChance > 60) {
                    icon = 'üåßÔ∏è';
                    condition = 'M∆∞a';
                } else if (rainChance > 30) {
                    icon = '‚õÖ';
                    condition = 'C√≥ m√¢y';
                } else if (avgHumidity > 80) {
                    icon = '‚òÅÔ∏è';
                    condition = 'Nhi·ªÅu m√¢y';
                }
                
                // Parse date
                const [day, month, year] = date.split('/');
                const dateObj = new Date(year, month - 1, day);
                const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                const dayName = dayNames[dateObj.getDay()];
                
                const card = document.createElement('div');
                card.className = 'forecast-card-7day';
                if (index === 0) card.classList.add('today');
                
                card.innerHTML = `
                    <div class="forecast-date">${dayName}, ${day}/${month}</div>
                    <div class="forecast-icon" style="font-size: 32px;">${icon}</div>
                    <div class="forecast-condition">${condition}</div>
                    <div class="forecast-temp">
                        <span class="temp-max">${tempMax.toFixed(0)}¬∞</span>
                        <span class="temp-min">${tempMin.toFixed(0)}¬∞</span>
                    </div>
                    <div class="forecast-details">
                        <span>üíß ${avgHumidity.toFixed(0)}%</span>
                    </div>
                    <div class="forecast-rain">‚òî ${rainChance.toFixed(0)}%</div>
                `;
                grid.appendChild(card);
            });
            
            // Add scroll buttons for 7-day forecast
            addScrollButtonsFor7Day();
            
        } catch (error) {
            console.error('Error loading 7-day forecast:', error);
            grid.innerHTML = '<div class="error-text">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ª± b√°o. Vui l√≤ng train model tr∆∞·ªõc.</div>';
        }
    }

    // Load hourly forecast from ML model (nh∆∞ trang forecast)
    async function loadForecastHourly() {
        const grid = document.getElementById('forecastHourlyGrid');
        grid.innerHTML = '<div class="loading-text" style="grid-column: 1/-1; text-align: center; padding: 40px;">ƒêang t·∫£i d·ª± b√°o...</div>';
        
        try {
            const response = await fetch('/api/ml/predict?hours_ahead=24');
            if (!response.ok) throw new Error('Failed to fetch forecast');
            const data = await response.json();
            
            if (!data.forecasts || data.forecasts.length === 0) {
                throw new Error('No forecast data');
            }
            
            grid.innerHTML = '';
            
            // Helper function to get translation
            const t = (key) => typeof getTranslation === 'function' ? getTranslation(key) : key.split('.').pop();
            
            // Display all 24 hours
            data.forecasts.slice(0, 24).forEach((forecast, index) => {
                const tempValue = parseFloat(forecast.temperature);
                const humidityValue = parseFloat(forecast.humidity);
                const uvIndex = parseFloat(forecast.uv_index) || 0;
                const rainfall = parseFloat(forecast.rainfall) || 0;
                
                // L·∫•y gi·ªù t·ª´ timestamp ƒë·ªÉ x√°c ƒë·ªãnh ban ng√†y/ƒë√™m
                const timeStr = forecast.timestamp.split(' ')[1] || '00:00:00';
                const hour = parseInt(timeStr.split(':')[0]) || 0;
                const isDaytime = hour >= 10 && hour <= 18;
                
                // X√°c ƒë·ªãnh icon v√† ƒëi·ªÅu ki·ªán th·ªùi ti·∫øt
                let weatherIcon, rainText, isRain;
                
                if (forecast.weather_icon && forecast.weather_condition_key) {
                    weatherIcon = forecast.weather_icon;
                    rainText = t(`forecastExt.${forecast.weather_condition_key}`);
                    isRain = forecast.willRain || false;
                } else if (forecast.weather_icon && forecast.weather_condition) {
                    weatherIcon = forecast.weather_icon;
                    rainText = forecast.weather_condition;
                    isRain = forecast.willRain || false;
                } else if (forecast.weather_condition) {
                    const condition = forecast.weather_condition;
                    isRain = condition.includes('M∆∞a') || condition.includes('Rain');
                    rainText = condition;
                    
                    if (condition.includes('M∆∞a') || condition.includes('Rain')) {
                        weatherIcon = 'üåßÔ∏è';
                    } else if (condition.includes('N·∫Øng') || condition.includes('Sunny')) {
                        weatherIcon = isDaytime ? '‚òÄÔ∏è' : 'üåô';
                    } else if (condition.includes('m√¢y') || condition.includes('M√¢y') || condition.includes('Cloud')) {
                        weatherIcon = '‚òÅÔ∏è';
                    } else if (condition.includes('ƒê√™m') || condition.includes('ƒë√™m') || condition.includes('Night')) {
                        weatherIcon = 'üåô';
                    } else if (condition.includes('S∆∞∆°ng') || condition.includes('Fog')) {
                        weatherIcon = 'üå´Ô∏è';
                    } else if (condition.includes('S√°ng s·ªõm') || condition.includes('Morning')) {
                        weatherIcon = 'üåÖ';
                    } else if (condition.includes('Chi·ªÅu t·ªëi') || condition.includes('Evening')) {
                        weatherIcon = 'üåÜ';
                    } else {
                        weatherIcon = isDaytime ? '‚õÖ' : 'üåô';
                    }
                } else {
                    // Fallback: t√≠nh to√°n d·ª±a tr√™n gi·ªù, UV, humidity, rainfall
                    if (rainfall > 0.5 || forecast.willRain) {
                        isRain = true;
                        weatherIcon = 'üåßÔ∏è';
                        rainText = 'C√≥ m∆∞a';
                    } else if (isDaytime) {
                        if (uvIndex >= 6) {
                            isRain = false;
                            weatherIcon = '‚òÄÔ∏è';
                            rainText = 'N·∫Øng';
                        } else if (uvIndex >= 3) {
                            isRain = false;
                            weatherIcon = 'üå§Ô∏è';
                            rainText = 'N·∫Øng nh·∫π';
                        } else {
                            isRain = false;
                            weatherIcon = '‚òÅÔ∏è';
                            rainText = 'Nhi·ªÅu m√¢y';
                        }
                    } else {
                        if (rainfall > 0) {
                            isRain = true;
                            weatherIcon = 'üåßÔ∏è';
                            rainText = 'M∆∞a ƒë√™m';
                        } else if (humidityValue > 90) {
                            isRain = false;
                            weatherIcon = 'üå´Ô∏è';
                            rainText = 'S∆∞∆°ng m√π';
                        } else if (hour >= 6 && hour < 10) {
                            isRain = false;
                            weatherIcon = 'üåÖ';
                            rainText = 'S√°ng s·ªõm';
                        } else if (hour > 18 && hour <= 20) {
                            isRain = false;
                            weatherIcon = 'üåÜ';
                            rainText = 'Chi·ªÅu t·ªëi';
                        } else {
                            isRain = false;
                            weatherIcon = 'üåô';
                            rainText = 'ƒê√™m quang';
                        }
                    }
                }
                
                const confidence = parseInt(forecast.confidence) || 0;
                
                const card = document.createElement('div');
                card.className = 'forecast-card';
                card.style.animation = `fadeInUp 0.3s ease ${index * 0.05}s both`;
                
                card.innerHTML = `
                    <div class="forecast-time">${timeStr.substring(0, 5)}</div>
                    <div class="forecast-icon">${weatherIcon || 'üå§Ô∏è'}</div>
                    <div class="forecast-temp">${isNaN(tempValue) ? '--' : tempValue.toFixed(1)}¬∞C</div>
                    <div class="forecast-details">
                        üíß ${isNaN(humidityValue) ? '--' : humidityValue.toFixed(0)}%<br>
                        üìä ${forecast.pressure || '--'} hPa
                    </div>
                    <div class="rain-indicator ${isRain ? 'rain-yes' : 'rain-no'}">
                        ${weatherIcon} ${rainText}
                    </div>
                    <div class="confidence-badge" style="margin-top: 6px;">üìä ${confidence}%</div>
                `;
                grid.appendChild(card);
            });
            
        } catch (error) {
            console.error('Error loading hourly forecast:', error);
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--danger);">
                    <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    <div style="font-size: 16px; font-weight: bold;">L·ªói t·∫£i d·ª± b√°o</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 10px;">${error.message}</div>
                </div>
            `;
        }
    }

    function addScrollButtonsHourly() {
        const container = document.querySelector('.forecast-grid-container');
        if (!container) return;

        const existingBtn = container.querySelectorAll('.scroll-btn');
        existingBtn.forEach(btn => btn.remove());

        const leftBtn = document.createElement('button');
        leftBtn.className = 'scroll-btn scroll-left';
        leftBtn.innerHTML = '‚ùÆ';
        leftBtn.onclick = () => {
            const grid = document.getElementById('forecastHourlyGrid');
            grid.parentElement.scrollBy({ left: -400, behavior: 'smooth' });
        };

        const rightBtn = document.createElement('button');
        rightBtn.className = 'scroll-btn scroll-right';
        rightBtn.innerHTML = '‚ùØ';
        rightBtn.onclick = () => {
            const grid = document.getElementById('forecastHourlyGrid');
            grid.parentElement.scrollBy({ left: 400, behavior: 'smooth' });
        };

        container.appendChild(leftBtn);
        container.appendChild(rightBtn);
    }

    function addScrollButtonsFor7Day() {
        const container = document.getElementById('forecast7DayContainer');
        if (!container) return;

        const existingBtn = container.querySelectorAll('.scroll-btn');
        existingBtn.forEach(btn => btn.remove());

        const leftBtn = document.createElement('button');
        leftBtn.className = 'scroll-btn scroll-left';
        leftBtn.innerHTML = '‚ùÆ';
        leftBtn.onclick = () => {
            const grid = document.getElementById('forecast7DayGrid');
            grid.scrollBy({ left: -200, behavior: 'smooth' });
        };

        const rightBtn = document.createElement('button');
        rightBtn.className = 'scroll-btn scroll-right';
        rightBtn.innerHTML = '‚ùØ';
        rightBtn.onclick = () => {
            const grid = document.getElementById('forecast7DayGrid');
            grid.scrollBy({ left: 200, behavior: 'smooth' });
        };

        container.appendChild(leftBtn);
        container.appendChild(rightBtn);
    }

    // Load realtime data using API
    async function loadRealtimeData() {
        const cards = document.getElementById('iotDataCards');
        const loading = AppUtils.showLoading(cards);

        try {
            // Fetch from API endpoint
            const response = await fetch('/api/realtime-data');
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.json();

            // Update hero section
            document.getElementById('currentTemp').textContent = `${data.temperature}¬∞C`;
            document.getElementById('weatherDesc').textContent = 'Th·ªùi ti·∫øt hi·ªán t·∫°i';
            document.getElementById('heroHumidity').textContent = `${data.humidity}%`;
            document.getElementById('heroWind').textContent = `${data.wind_speed}km/h`;
            document.getElementById('heroPressure').textContent = `${data.pressure}hPa`;
            document.getElementById('lastUpdate').textContent = `C·∫≠p nh·∫≠t l√∫c ${data.timestamp}`;

            // Update IoT data cards
            document.getElementById('tempValue').innerHTML = `${data.temperature}<span class="card-unit">¬∞C</span>`;
            document.getElementById('humidityValue').innerHTML = `${data.humidity}<span class="card-unit">%</span>`;
            document.getElementById('pressureValue').innerHTML = `${data.pressure}<span class="card-unit">hPa</span>`;
            document.getElementById('co2Value').innerHTML = `${data.co2}<span class="card-unit">ppm</span>`;
            document.getElementById('dustValue').innerHTML = `${data.dust}<span class="card-unit">¬µg/m¬≥</span>`;

            // Update timestamps
            const timestamp = `C·∫≠p nh·∫≠t: ${data.timestamp}`;
            document.getElementById('tempTime').textContent = timestamp;
            document.getElementById('humidityTime').textContent = timestamp;
            document.getElementById('pressureTime').textContent = timestamp;
            document.getElementById('co2Time').textContent = timestamp;
            document.getElementById('dustTime').textContent = timestamp;

            // Update weather API data
            document.getElementById('windSpeedValue').innerHTML = `${data.wind_speed}<span class="card-unit">km/h</span>`;
            document.getElementById('rainfallValue').innerHTML = `${data.rainfall}<span class="card-unit">mm</span>`;
            document.getElementById('uvValue').textContent = data.uv_index;
            document.getElementById('uvLevel').textContent = AppUtils.getUVLevel(data.uv_index);

            // Update system status via API
            const statsResponse = await fetch('/api/system-stats');
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                document.getElementById('lastDataTime').textContent = stats.last_update;
                document.getElementById('recordsToday').textContent = stats.records_today;
                document.getElementById('activeSensors').textContent = stats.active_sensors;
            }

            AppUtils.showToast('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu th√†nh c√¥ng', 'success');
        } catch (error) {
            console.error('Error loading data:', error);
            AppUtils.showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        } finally {
            AppUtils.hideLoading(loading);
        }
    }

    // Load location settings
    async function loadLocationSettings() {
        try {
            const settingsResponse = await fetch('/api/settings');
            if (settingsResponse.ok) {
                const settings = await settingsResponse.json();
                if (settings.location && settings.location.name) {
                    document.getElementById('locationDisplay').textContent = `üìç ${settings.location.name}`;
                    localStorage.setItem('locationName', settings.location.name);
                } else {
                    const savedLocation = localStorage.getItem('locationName');
                    if (savedLocation) {
                        document.getElementById('locationDisplay').textContent = `üìç ${savedLocation}`;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading location:', error);
            // Use saved location from localStorage
            const savedLocation = localStorage.getItem('locationName');
            if (savedLocation) {
                document.getElementById('locationDisplay').textContent = `üìç ${savedLocation}`;
            }
        }
    }

    // Listen for location updates from settings page
    window.addEventListener('locationUpdated', (event) => {
        const { name } = event.detail;
        document.getElementById('locationDisplay').textContent = `üìç ${name}`;
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadLocationSettings();
        loadRealtimeData();
        loadForecast7Day();
        loadForecastHourly();

        // Auto-refresh every 30 seconds
        setInterval(loadRealtimeData, 30000);
        
        // Refresh forecasts every 5 minutes
        setInterval(() => {
            loadForecast7Day();
            loadForecastHourly();
        }, 300000);
    });
</script>

<script src="/static/js/index.js"></script>
{% endblock %}