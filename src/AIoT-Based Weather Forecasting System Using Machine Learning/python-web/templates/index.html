{% extends "base.html" %}

{% block title %}Tá»•ng quan - AIoT Weather{% endblock %}
{% block page_title %}Tá»•ng quan thá»i tiáº¿t{% endblock %}

{% block content %}
<!-- Current Weather Overview -->
<section class="section">
    <div class="weather-hero">
        <div class="hero-content">
            <div class="current-temp-display">
                <div class="current-temp" id="currentTemp">--Â°C</div>
                <div class="weather-description" id="weatherDesc">Äang táº£i...</div>
            </div>
            <div class="hero-info">
                <div class="info-item">
                    <span class="info-label">ğŸ’§ Äá»™ áº©m</span>
                    <span class="info-value" id="heroHumidity">--%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ğŸ’¨ GiÃ³</span>
                    <span class="info-value" id="heroWind">--km/h</span>
                </div>
                <div class="info-item">
                    <span class="info-label">â±ï¸ Ãp suáº¥t</span>
                    <span class="info-value" id="heroPressure">--hPa</span>
                </div>
            </div>
        </div>
        <div class="location-info">
            <span id="locationDisplay">ğŸ“ Quáº­n 9, TP.HCM</span>
            <span class="last-update" id="lastUpdate">Cáº­p nháº­t lÃºc --</span>
        </div>
    </div>
</section>

<!-- Real-time IoT Sensor Data -->
<section class="section">
    <h2 class="section-title">ğŸ“¡ Dá»¯ liá»‡u cáº£m biáº¿n IoT (Thá»i gian thá»±c)</h2>
    <div class="cards-grid" id="iotDataCards">
        <div class="card">
            <div class="card-header">
                <div class="card-icon temp">ğŸŒ¡ï¸</div>
                <div class="card-label">Nhiá»‡t Ä‘á»™</div>
            </div>
            <div class="card-value" id="tempValue">--<span class="card-unit">Â°C</span></div>
            <div class="card-footer" id="tempTime">Äang táº£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon humidity">ğŸ’§</div>
                <div class="card-label">Äá»™ áº©m</div>
            </div>
            <div class="card-value" id="humidityValue">--<span class="card-unit">%</span></div>
            <div class="card-footer" id="humidityTime">Äang táº£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon pressure">â±ï¸</div>
                <div class="card-label">Ãp suáº¥t</div>
            </div>
            <div class="card-value" id="pressureValue">--<span class="card-unit">hPa</span></div>
            <div class="card-footer" id="pressureTime">Äang táº£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon co2">ğŸ’¨</div>
                <div class="card-label">COâ‚‚</div>
            </div>
            <div class="card-value" id="co2Value">--<span class="card-unit">ppm</span></div>
            <div class="card-footer" id="co2Time">Äang táº£i...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon dust">ğŸŒ«ï¸</div>
                <div class="card-label">Bá»¥i má»‹n</div>
            </div>
            <div class="card-value" id="dustValue">--<span class="card-unit">Âµg/mÂ³</span></div>
            <div class="card-footer" id="dustTime">Äang táº£i...</div>
        </div>
    </div>
    <div class="text-center mt-10">
        <button class="btn btn-primary" onclick="loadRealtimeData()">
            ğŸ”„ Cáº­p nháº­t dá»¯ liá»‡u
        </button>
    </div>
</section>

<!-- Weather API Data -->
<section class="section">
    <h2 class="section-title">ğŸŒ Dá»¯ liá»‡u tá»« API Thá»i tiáº¿t</h2>
    <div class="cards-grid" id="weatherApiCards">
        <div class="card">
            <div class="card-header">
                <div class="card-icon wind">ğŸŒ¬ï¸</div>
                <div class="card-label">Tá»‘c Ä‘á»™ giÃ³</div>
            </div>
            <div class="card-value" id="windSpeedValue">--<span class="card-unit">km/h</span></div>
            <div class="card-footer">GiÃ³</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon rain">ğŸŒ§ï¸</div>
                <div class="card-label">LÆ°á»£ng mÆ°a</div>
            </div>
            <div class="card-value" id="rainfallValue">--<span class="card-unit">mm</span></div>
            <div class="card-footer">MÆ°a</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon uv">â˜€ï¸</div>
                <div class="card-label">Chá»‰ sá»‘ UV</div>
            </div>
            <div class="card-value" id="uvValue">--</div>
            <div class="card-footer" id="uvLevel">--</div>
        </div>
    </div>
</section>

<!-- 7-Day Weather Forecast -->
<section class="section">
    <h2 class="section-title">ğŸ“… Dá»± bÃ¡o 7 ngÃ y</h2>
    <p class="section-subtitle">Dá»± bÃ¡o thá»i tiáº¿t trong 7 ngÃ y tá»›i tá»« API thá»i tiáº¿t</p>
    <div class="forecast-grid-7day" id="forecast7DayGrid">
        <!-- Will be populated by JavaScript -->
    </div>
</section>

<!-- Today Hourly Forecast -->
<section class="section">
    <h2 class="section-title">ğŸ“ˆ Dá»± bÃ¡o theo giá» (24 giá»)</h2>
    <p class="section-subtitle">Dá»± bÃ¡o thá»i tiáº¿t chi tiáº¿t tá»«ng giá» trong 24 giá» tá»›i</p>
    <div class="forecast-scroll-container">
        <div class="forecast-grid-hourly" id="forecastHourlyGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</section>

<!-- System Status -->
<section class="section">
    <h2 class="section-title">âš™ï¸ Tráº¡ng thÃ¡i há»‡ thá»‘ng</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“¡</div>
            <div class="stat-label">Cáº£m biáº¿n hoáº¡t Ä‘á»™ng</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">Sá»‘ lÆ°á»£ng</span>
                    <span class="stat-value-small" id="activeSensors">5</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ’¾</div>
            <div class="stat-label">Báº£n ghi dá»¯ liá»‡u</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">HÃ´m nay</span>
                    <span class="stat-value-small" id="recordsToday">--</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â°</div>
            <div class="stat-label">Cáº­p nháº­t láº§n cuá»‘i</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">Thá»i gian</span>
                    <span class="stat-value-small" id="lastDataTime">--</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ“</div>
            <div class="stat-label">Tráº¡ng thÃ¡i</div>
            <div class="stat-details">
                <div class="stat-row">
                    <span class="stat-label-small">Há»‡ thá»‘ng</span>
                    <span class="stat-value-small" style="color: #48bb78;" id="systemStatus">Hoáº¡t Ä‘á»™ng</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Page-specific JavaScript
    let trendData = {
        temperature: [],
        humidity: [],
        co2: [],
        dust: []
    };

    // Generate 7-day forecast data
    function generateForecast7Day() {
        const forecast = [];
        const weatherConditions = ['Náº¯ng', 'MÃ¢y', 'MÆ°a', 'Náº¯ng', 'MÃ¢y', 'MÆ°a', 'Náº¯ng'];
        const icons = ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'â˜€ï¸'];
        const today = new Date();
        const currentDayOfWeek = today.getDay();
        let daysUntilMonday = (1 - currentDayOfWeek + 7) % 7;
        if (daysUntilMonday === 0) daysUntilMonday = 7;
        const startDate = new Date(today);
        startDate.setDate(today.getDate() + daysUntilMonday);

        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            const dayOfWeek = date.getDay();
            const dayNames = ['Chá»§ nháº­t', 'Thá»© 2', 'Thá»© 3', 'Thá»© 4', 'Thá»© 5', 'Thá»© 6', 'Thá»© 7'];
            const dayName = dayNames[dayOfWeek];
            const monthDay = date.toLocaleDateString('vi-VN', { month: '2-digit', day: '2-digit' });

            forecast.push({
                date: `${dayName}, ${monthDay}`,
                condition: weatherConditions[i],
                icon: icons[i],
                tempMax: 28 + Math.random() * 5,
                tempMin: 22 + Math.random() * 3,
                humidity: 65 + Math.random() * 20,
                windSpeed: 10 + Math.random() * 8,
                rainChance: Math.random() * 100
            });
        }
        return forecast;
    }

    function generateForecastHourly() {
        const forecast = [];
        const conditions = ['Náº¯ng', 'MÃ¢y', 'MÆ°a nháº¹', 'Náº¯ng'];
        const icons = ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'â˜€ï¸'];

        for (let i = 0; i < 24; i++) {
            const time = new Date();
            time.setHours(i);

            forecast.push({
                time: time.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }),
                hour: i,
                condition: conditions[Math.floor(Math.random() * conditions.length)],
                icon: icons[Math.floor(Math.random() * icons.length)],
                temp: 24 + Math.random() * 6,
                humidity: 60 + Math.random() * 30,
                windSpeed: 8 + Math.random() * 10,
                rainChance: Math.random() * 100
            });
        }
        return forecast;
    }

    function displayForecast7Day() {
        const forecast = generateForecast7Day();
        const grid = document.getElementById('forecast7DayGrid');
        grid.innerHTML = '';

        forecast.forEach(day => {
            const card = document.createElement('div');
            card.className = 'forecast-card-7day';
            card.innerHTML = `
                <div class="forecast-date">${day.date}</div>
                <div class="forecast-icon" style="font-size: 32px;">${day.icon}</div>
                <div class="forecast-condition">${day.condition}</div>
                <div class="forecast-temp">
                    <span class="temp-max">${day.tempMax.toFixed(0)}Â°</span>
                    <span class="temp-min">${day.tempMin.toFixed(0)}Â°</span>
                </div>
                <div class="forecast-details">
                    <span>ğŸ’§ ${day.humidity.toFixed(0)}%</span>
                    <span>ğŸ’¨ ${day.windSpeed.toFixed(0)}km/h</span>
                </div>
                <div class="forecast-rain">â˜” ${day.rainChance.toFixed(0)}%</div>
            `;
            grid.appendChild(card);
        });
    }

    function displayForecastHourly() {
        const forecast = generateForecastHourly();
        const grid = document.getElementById('forecastHourlyGrid');
        grid.innerHTML = '';

        forecast.forEach((hour, index) => {
            const card = document.createElement('div');
            card.className = 'forecast-card-hourly';
            if (index === new Date().getHours()) {
                card.classList.add('current-hour');
            }
            card.innerHTML = `
                <div class="forecast-hour">${hour.time}</div>
                <div class="forecast-icon" style="font-size: 28px;">${hour.icon}</div>
                <div class="forecast-temp-main">${hour.temp.toFixed(0)}Â°C</div>
                <div class="forecast-condition-small">${hour.condition}</div>
                <div class="forecast-details-small">
                    <span>ğŸ’§ ${hour.humidity.toFixed(0)}%</span>
                </div>
                <div class="forecast-details-small">
                    <span>ğŸ’¨ ${hour.windSpeed.toFixed(0)}km/h</span>
                </div>
            `;
            grid.appendChild(card);
        });

        addScrollButtons();
    }

    function addScrollButtons() {
        const container = document.querySelector('.forecast-scroll-container');
        if (!container) return;

        const existingBtn = container.querySelectorAll('.scroll-btn');
        existingBtn.forEach(btn => btn.remove());

        const leftBtn = document.createElement('button');
        leftBtn.className = 'scroll-btn scroll-left';
        leftBtn.innerHTML = 'â®';
        leftBtn.onclick = () => {
            const grid = document.getElementById('forecastHourlyGrid');
            grid.parentElement.scrollBy({ left: -300, behavior: 'smooth' });
        };

        const rightBtn = document.createElement('button');
        rightBtn.className = 'scroll-btn scroll-right';
        rightBtn.innerHTML = 'â¯';
        rightBtn.onclick = () => {
            const grid = document.getElementById('forecastHourlyGrid');
            grid.parentElement.scrollBy({ left: 300, behavior: 'smooth' });
        };

        container.appendChild(leftBtn);
        container.appendChild(rightBtn);
    }

    // Load realtime data using API
    async function loadRealtimeData() {
        const cards = document.getElementById('iotDataCards');
        const loading = AppUtils.showLoading(cards);

        try {
            // Fetch from API endpoint
            const response = await fetch('/api/realtime-data');
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.json();

            // Update hero section
            document.getElementById('currentTemp').textContent = `${data.temperature}Â°C`;
            document.getElementById('weatherDesc').textContent = 'Thá»i tiáº¿t hiá»‡n táº¡i';
            document.getElementById('heroHumidity').textContent = `${data.humidity}%`;
            document.getElementById('heroWind').textContent = `${data.wind_speed}km/h`;
            document.getElementById('heroPressure').textContent = `${data.pressure}hPa`;
            document.getElementById('lastUpdate').textContent = `Cáº­p nháº­t lÃºc ${data.timestamp}`;

            // Update IoT data cards
            document.getElementById('tempValue').innerHTML = `${data.temperature}<span class="card-unit">Â°C</span>`;
            document.getElementById('humidityValue').innerHTML = `${data.humidity}<span class="card-unit">%</span>`;
            document.getElementById('pressureValue').innerHTML = `${data.pressure}<span class="card-unit">hPa</span>`;
            document.getElementById('co2Value').innerHTML = `${data.co2}<span class="card-unit">ppm</span>`;
            document.getElementById('dustValue').innerHTML = `${data.dust}<span class="card-unit">Âµg/mÂ³</span>`;

            // Update timestamps
            const timestamp = `Cáº­p nháº­t: ${data.timestamp}`;
            document.getElementById('tempTime').textContent = timestamp;
            document.getElementById('humidityTime').textContent = timestamp;
            document.getElementById('pressureTime').textContent = timestamp;
            document.getElementById('co2Time').textContent = timestamp;
            document.getElementById('dustTime').textContent = timestamp;

            // Update weather API data
            document.getElementById('windSpeedValue').innerHTML = `${data.wind_speed}<span class="card-unit">km/h</span>`;
            document.getElementById('rainfallValue').innerHTML = `${data.rainfall}<span class="card-unit">mm</span>`;
            document.getElementById('uvValue').textContent = data.uv_index;
            document.getElementById('uvLevel').textContent = AppUtils.getUVLevel(data.uv_index);

            // Update system status via API
            const statsResponse = await fetch('/api/system-stats');
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                document.getElementById('lastDataTime').textContent = stats.last_update;
                document.getElementById('recordsToday').textContent = stats.records_today;
                document.getElementById('activeSensors').textContent = stats.active_sensors;
            }

            AppUtils.showToast('ÄÃ£ cáº­p nháº­t dá»¯ liá»‡u thÃ nh cÃ´ng', 'success');
        } catch (error) {
            console.error('Error loading data:', error);
            AppUtils.showToast('Lá»—i khi táº£i dá»¯ liá»‡u: ' + error.message, 'error');
        } finally {
            AppUtils.hideLoading(loading);
        }
    }

    // Load location settings
    async function loadLocationSettings() {
        try {
            const settingsResponse = await fetch('/api/settings');
            if (settingsResponse.ok) {
                const settings = await settingsResponse.json();
                if (settings.location && settings.location.name) {
                    document.getElementById('locationDisplay').textContent = `ğŸ“ ${settings.location.name}`;
                    localStorage.setItem('locationName', settings.location.name);
                } else {
                    const savedLocation = localStorage.getItem('locationName');
                    if (savedLocation) {
                        document.getElementById('locationDisplay').textContent = `ğŸ“ ${savedLocation}`;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading location:', error);
            // Use saved location from localStorage
            const savedLocation = localStorage.getItem('locationName');
            if (savedLocation) {
                document.getElementById('locationDisplay').textContent = `ğŸ“ ${savedLocation}`;
            }
        }
    }

    // Listen for location updates from settings page
    window.addEventListener('locationUpdated', (event) => {
        const { name } = event.detail;
        document.getElementById('locationDisplay').textContent = `ğŸ“ ${name}`;
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadLocationSettings();
        loadRealtimeData();
        displayForecast7Day();
        displayForecastHourly();

        // Auto-refresh every 30 seconds
        setInterval(loadRealtimeData, 30000);
    });
</script>

<script src="/static/js/index.js"></script>
{% endblock %}